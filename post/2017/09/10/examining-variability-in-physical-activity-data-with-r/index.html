<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <title>Examining Variability in Longitudinal Physical Activity Datawith R | Ernesto Ramirez</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="/post/">Posts</a></li>
      
      <li><a href="/contact/">Contact</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Examining Variability in Longitudinal Physical Activity Datawith R</span></h1>

<h3 class="date">2017-09-10</h3>

<p class="terms">
  
  
  Categories: <a href="/categories/r">R</a> 
  
  
  
  Tags: <a href="/tags/data-visualization">data visualization</a> <a href="/tags/time-series">time series</a> <a href="/tags/fitbit">fitbit</a> 
  
  
</p>
</div>



<main>
<div id="intro" class="section level2">
<h2>Intro</h2>
<p>As part of my regular work I keep a constant eye on the latest published research that involves the use of Fitbit activity tracking devices. Each new publication is gathered, read (sometimes skimmed), and tagged with appropriate meta-data for our <a href="https://www.fitabase.com/research-library/">Fitabase Research Library</a>. It’s fun work, and it gives me a chance to peak into the every-expanding world of research and clinical use cases for consumer tracking devices and the data they can collect.</p>
<p>Earlier this summer, while I was traveling to a conference I came across an interesting paper published by a group from the University of South Florida that explored strategies for interpreting highly variable data from long-term use of a Fitbit. I’ll let them explain:</p>
<blockquote>
<p><em>Data Presentation Options to Manage Variability in Physical Activity Research</em><br />
This paper presents seven tactics for managing the variability evident in some physical activity data. High levels of variability in daily step-count data from pedometers or accelerometers can make typical visual inspection difficult. Therefore, the purpose of the current paper is to discuss several strategies that might facilitate the visual interpretation of highly variable data. The seven strategies discussed in this paper are phase mean and median lines, daily average per week, weekly cumulative, proportion of baseline, 7-day moving average, change point detection, and confidence intervals. We apply each strategy to a data set and discuss the advantages and disadvantages. <a href="http://onlinelibrary.wiley.com/doi/10.1002/jaba.397/abstract">LINK</a></p>
</blockquote>
<p>It’s an interesting paper, with some general, easy-to-use, methods of visualizing daily-scale time series data. While reading it, I got to thinking that all of the methods they explored should be able to be easily reproducible in R. Being a sucker for practicing my R skills I set out to create some reproducible examples of each method with my own Fitbit data. A few cross-country flights later I think I’ve done a decent enough job. Let’s jump in!</p>
<p><em>Note</em>. The data referenced below is available on Github (as you’ll see in the <code>read_csv</code> call). I invite you to use it so you can follow along with the examples below.</p>
</div>
<div id="the-eight-visualization-methods" class="section level2">
<h2>The Eight Visualization Methods</h2>
<div id="the-data" class="section level3">
<h3>The Data</h3>
<p>In the paper, they use approximately 180 days of daily step data from a Fitbit One that was worn by a participant in a previous study. It’s important to note that this data comes from an intervention study, with three phases: baseline, intervention phase 1, and intervention phase 2. Now, we don’t have access to their participant’s data, so I set out to use my own. Using our Fitabase platform I exported one year of daily step data, from 2016-05-12 to 2017-05-11. I also applied somewhat arbitrary cutoffs for the three phases: 30 days for “baseline”, 135 days for “intervention 1”, and 200 days for “intervention 2”.</p>
<pre class="r"><code>library(tidyverse)
library(scales)
library(ggthemes)
library(lubridate)</code></pre>
<pre class="r"><code># Load data 
# format date when loading in
Daily_Steps &lt;- read_csv(&quot;https://raw.githubusercontent.com/erramirez/datascience/master/sevenways/dailySteps_20160512_20170511.csv&quot;, 
   col_types = cols(
    ActivityDay= col_date(&quot;%m/%d/%Y&quot;), 
    StepTotal = col_integer()))

# create a day variable to number the observations by day
# used first day as &quot;1&quot; instead of zero
# add a observation variable with three periods
# Day 1 - 30  = baseline
# Day 31 - 165 = intervention 1
# Day 195 - 365 = intervention 2
startdate &lt;- min(Daily_Steps$ActivityDay)

Daily_Steps &lt;- Daily_Steps %&gt;% 
  mutate(days = as.numeric(difftime(ActivityDay, startdate, units = &quot;days&quot;) + 1),
         observation = as.factor(case_when(days &lt;= 30 ~&quot;Baseline&quot;,
                                           days &lt; 195 ~ &quot;Intervention 1&quot;,
                                           days &lt;= 365 ~ &quot;Intervention 2&quot;)))</code></pre>
</div>
<div id="daily-steps" class="section level3">
<h3>1. Daily Steps</h3>
<p>Pretty simple here, let’s just visualize the daily steps taken with days along the <em>x</em>-axis and total steps on the <em>y</em>.</p>
<p>In this plot, and the plots that follow I attempted to use similar formatting to what was presented in the article. They’re pretty minimal so I went with <code>theme_tufte</code> from the excellent <a href="https://github.com/jrnold/ggthemes">ggthemes package</a>.</p>
<pre class="r"><code># generate a line+points plot to show one year of daily step data
# add some formatting to match journal article 

daily_steps_plot &lt;- ggplot(Daily_Steps, aes(days, StepTotal)) +
  geom_line(size = .35) +
  geom_point() +
  scale_x_continuous(breaks = seq(0,365,20), expand = c(.01, .01)) +
  scale_y_continuous(breaks = seq(0,35000,5000), limits = c(0,38000)) +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.line = element_line(colour = &quot;black&quot;)) +
  theme(axis.line.x = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1),
        axis.line.y = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1)) +
  theme(axis.text.x = element_text(size = 6)) +
  labs(title = &quot;Daily Steps&quot;, 
       x = &quot;DAYS&quot;, 
       y = &quot;STEPS&quot;) +
  geom_vline(xintercept = c(30.5, 195.5)) +
  annotate(&quot;text&quot;, x = c(15, 112.5, 277.5), y = 38000, 
           label = c(&quot;BL&quot;, &quot;Intervention 1&quot;, &quot;Intervention 2&quot;))

daily_steps_plot</code></pre>
<p><img src="/post/2017-09-10-examining-variability-in-phsyical-activity-with-r_files/figure-html/dailysteps-1.png" width="672" /></p>
</div>
<div id="phase-mean-and-phase-median-lines" class="section level3">
<h3>2. Phase Mean and Phase Median Lines</h3>
<p>This was also pretty simple. To better understand how the daily steps varied from the mean and median values for each observation period (baseline, intervention 1, intervention 2) we can use <code>group_by</code> and <code>summarise</code> to easily calculate the mean and median and plug those values into <code>geom_segment</code> in order to plot three separate lines with the correct start and end dates.</p>
<p>This method of creating an additional data set to use in conjunction with <code>geom_segment</code> will be useful throughout the remainder to of the visualizations we go over here.</p>
<pre class="r"><code># create data sets for mean/median grouped by observation period
# also add start and stop days per observation period

observation_data &lt;- Daily_Steps %&gt;% 
  group_by(observation) %&gt;% 
  summarise(mean = mean(StepTotal),
            median = median(StepTotal),
            start = min(days), 
            end = max(days))

# create a plot with mean steps per day per observation period
# uses geom_segment and observation_data to draw mean lines

phase_mean_plot &lt;- ggplot(Daily_Steps, aes(days, StepTotal)) +
  geom_line(size = .35) +
  geom_point() +
  scale_x_continuous(breaks = seq(0,365,20), expand = c(.01, .01)) +
  scale_y_continuous(breaks = seq(0,35000,5000), limits = c(0,35000)) +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.line = element_line(colour = &quot;black&quot;)) +
  theme(axis.line.x = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1),
        axis.line.y = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1)) +
  theme(axis.text.x = element_text(size = 6)) +
  labs(title = &quot;Daily Steps&quot;,
       subtitle = &quot;With Mean Steps per Day per Observation Period&quot;,
       x = &quot;DAYS&quot;, 
       y = &quot;STEPS&quot;) +
  geom_vline(xintercept = c(30, 195)) +
  annotate(&quot;text&quot;, x = c(15, 112.5, 277.5),
           y = 34000, 
           label = c(&quot;BL&quot;, &quot;Intervention 1&quot;, &quot;Intervention 2&quot;)) +
  geom_segment(aes(x = start, y = mean, xend = end, yend = mean), data = observation_data)

phase_mean_plot</code></pre>
<p><img src="/post/2017-09-10-examining-variability-in-phsyical-activity-with-r_files/figure-html/phase_means-1.png" width="672" /></p>
<pre class="r"><code># create a plot with median steps per day per observation period
# uses geom_segment and observation_data to draw median lines

phase_median_plot &lt;- ggplot(Daily_Steps, aes(days, StepTotal)) + 
  geom_line(size = .35) +
  geom_point() +
  scale_x_continuous(breaks = seq(0,365,20), expand = c(.01, .01)) +
  scale_y_continuous(breaks = seq(0,35000,5000), limits = c(0,35000)) +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.line = element_line(colour = &quot;black&quot;)) +
  theme(axis.line.x = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1),
        axis.line.y = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1)) +
  theme(axis.text.x = element_text(size = 6)) +
  labs(title = &quot;Daily Steps&quot;,
       subtitle = &quot;With Median Steps per Day per Observation Period&quot;,
       x = &quot;DAYS&quot;, 
       y = &quot;STEPS&quot;) +
  geom_vline(xintercept = c(30, 195)) +
  annotate(&quot;text&quot;, x = c(15, 112.5, 277.5),
           y = 34000, 
           label = c(&quot;BL&quot;, &quot;Intervention 1&quot;, &quot;Intervention 2&quot;)) +
  geom_segment(aes(x = start, y = median, xend = end, yend = median), data = observation_data)
  
phase_median_plot  </code></pre>
<p><img src="/post/2017-09-10-examining-variability-in-phsyical-activity-with-r_files/figure-html/phase_medians-1.png" width="672" /></p>
</div>
<div id="daily-average-per-week-and-weekly-median" class="section level3">
<h3>3. Daily Average per Week and Weekly Median</h3>
<p>Now things start to get interesting! Understanding the variability at longer time scale is a nice way to better understand how activity changes over longer periods of time. In this example, we’re reducing the daily variability to weekly variability by calculating the mean and median steps per day for each week in the data set.</p>
<p>While this seems easy, there are some choices we have to make here. Primarily, what is a week? Is a calendar week? Is it just seven consecutive days? If it’s a calendar week, does is start or end on Sunday? What happens when a week transverses an study phase transition?</p>
<p>For ease of creating reusable examples we can actually explore how to derive a “week” using two definitions:</p>
<ul>
<li>A Monday-Sunday seven-day week</li>
<li>A running seven-day week, regardless of day of the week</li>
</ul>
<p>In this first method, we use <code>isoweek</code> from the <code>lubridate</code> package to find the week number based on a Monday-Sunday week. Keep in mind that our data spans both 2016 and 2017, so the resulting <em>week</em> variable will repeat and return the same value for the beginning and ending observations since the data doesn’t start on a Monday. I also wanted to create a variable, <em>weeknum</em>, that reflected the number of weeks elapsed. Last week I was exploring how to calculate streaks in data, and stumbled upon <a href="https://stackoverflow.com/questions/1502910/how-can-i-count-runs-in-a-sequence">a great comment stackoverflow</a> about numbering runs in a series. I applied that here, and started <em>weeknum</em> at 1 instead of 0.</p>
<pre class="r"><code># create week variable based on isoweek
# create weenum variable for running week number as weeknum restarts at begining of the year
Daily_Steps &lt;- Daily_Steps %&gt;% 
  mutate(week = isoweek(Daily_Steps$ActivityDay),
         weeknum = c(0,cumsum(week[-1L] != week[-length(week)]))+1
  )</code></pre>
<p>In the second method, wanted to explore how to set a week as seven consecutive daily observations regardless of the day of the week. I had some old code I used during my dissertation that I was able to re-use here. It’s not pretty and could probably be updated to make use of tidyverse principles, but it works for now. <em>(Tips/ideas on how to improve this section are welcomed!)</em></p>
<pre class="r"><code># function to create data frame of length: 7 observations
weekwindow &lt;- function(x) {
  week &lt;- x[n:(n+6),]
  return(week)
} 

# initialize n to value 1
n &lt;- 1

#create empty list
Daily_Steps_list &lt;- list()

#loop through data and append 7-day moving windows to the list
for (i in 1:53) { #set length of function to 1:number of weeks in the data set
  df &lt;- weekwindow(Daily_Steps) #create a new dataframe based on weekwindow function
  df$dayreg &lt;- c(1:nrow(df)) #create a new variable and set to the day in the 7-day window (1:7)
  df$week &lt;- i #create a new variable and set to the value of i; gives week number
  Daily_Steps_list[[i]] &lt;- df #adds the dataframe (df) to the empty list previously set
  n &lt;- n+7 #increments n by 7 so weeknumber function calls next 7 days. 
} 

# combine all 7-day/week data frames in week.list into a single dataframe
# get rid of trailing NA entries from week 53
Daily_Steps_7DayWeek &lt;- bind_rows(Daily_Steps_list) %&gt;% 
  filter(ActivityDay &lt;= &quot;2017-05-11&quot;)</code></pre>
<p>So now, we have two data sets that reflect two different ways to explore weeks in our data. Now comes the fun part - visualizing it! I personally like calendar weeks (isoweek / method one above), as they make conceptual sense when we’re talking about dates so I’ll use that data as the basis for creating the plots. First, we have to create the summarized data set so we have the daily mean, median and standard deviation per week. We do have to keep in mind here that not all weeks will have seven days as obervations may have started/ended in the middle of a week (in this data week 1 only has 4 days).</p>
<pre class="r"><code># summarize data by week number
# append observation variable to summarized weekly data
# Baseline = Weeks 1-5
# Intervention 1 = Weeks 6-28
# Intervention 2 = Weeks 29-53
Mean_Median_Week &lt;- Daily_Steps %&gt;%  
  group_by(weeknum) %&gt;% 
  summarise(mean = mean(StepTotal),
            median = median(StepTotal),
            sd = sd(StepTotal)) %&gt;% 
  mutate(observation = case_when(weeknum &lt;= 5 ~ &quot;Baseline&quot;,
                                 weeknum &lt;= 28 ~ &quot;Intervention 1&quot;,
                                 weeknum &lt;= 53 ~ &quot;Intervention 2&quot;)
         )</code></pre>
<p>Now we can plot. We’ll use a good deal of the code we used in the previous plots here. However, note that we’re grouping by the observation so that we have distinct series visualized in the plot.</p>
<pre class="r"><code># plot the mean week with standard deviation error bars
# seperate the oberservation periods using geom_vline
Mean_Week &lt;- ggplot(Mean_Median_Week, aes(weeknum, mean, group = observation)) + 
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = mean-sd, ymax = mean+sd), width = .5) +
  scale_x_continuous(breaks = seq(0,53,1), limits = c(0,53), expand = c(.01, .01)) +
  scale_y_continuous(breaks = seq(0,28000,2000), limits = c(0,28000)) +
  #theme_tufte() +
  #geom_rangeframe() +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.line = element_line(colour = &quot;black&quot;)) +
  theme(axis.line.x = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1),
        axis.line.y = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1)) +
  theme(axis.text.x = element_text(size = 6)) +
  labs(title = &quot;Daily Average Steps per Week&quot;,
       x = &quot;WEEKS&quot;, 
       y = &quot;AVERAGE DAILY STEPS&quot;,
       caption = &quot;Note: Error bars depict the standard deviation of the mean.&quot;) +
  geom_vline(xintercept = c(5.5, 28.5)) +
  annotate(&quot;text&quot;, x = c(2.25, 16, 42),
           y = 25000, 
           label = c(&quot;BL&quot;, &quot;Intervention 1&quot;, &quot;Intervention 2&quot;))

Mean_Week</code></pre>
<p><img src="/post/2017-09-10-examining-variability-in-phsyical-activity-with-r_files/figure-html/mean_week_plot-1.png" width="672" /></p>
<pre class="r"><code># plot the median step counts per week
Median_Week &lt;- ggplot(Mean_Median_Week, aes(weeknum, median, group = observation)) + 
  geom_point() +
  geom_line() +
  scale_x_continuous(breaks = seq(0,53,1), limits = c(0,53), expand = c(.01, .01)) +
  scale_y_continuous(breaks = seq(0,19000,2000), limits = c(0,19000)) +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.line = element_line(colour = &quot;black&quot;)) +
  theme(axis.line.x = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1),
        axis.line.y = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1)) +
  theme(axis.text.x = element_text(size = 6)) +
  labs(title = &quot;Median Daily Steps per Week&quot;,
       x = &quot;WEEKS&quot;, 
       y = &quot;MEDIAN DAILY STEPS&quot;) +
  geom_vline(xintercept = c(5.5, 28.5)) +
annotate(&quot;text&quot;, x = c(2.25, 16, 42),
           y = 18000, 
           label = c(&quot;BL&quot;, &quot;Intervention 1&quot;, &quot;Intervention 2&quot;))
Median_Week</code></pre>
<p><img src="/post/2017-09-10-examining-variability-in-phsyical-activity-with-r_files/figure-html/median_week_plot-1.png" width="672" /></p>
</div>
<div id="weekly-cumulative" class="section level3">
<h3>4. Weekly Cumulative</h3>
<p>This is actually one of the easier visualizations as we can make use of our previously calculated <em>weeknum</em> to calculate the weekly cumulative sum.</p>
<p>Why would weekly cumulative sums be interesting? Well, many interventions may focus on the weekly total steps (10,000 per day is 70,000 per week), and this plot can quickly show you when those weekly goals are met. This type of visualization also provides a way to see day-to-day variation and week-to-week variation in activity within one plot. By quickly glancing at the vertical space between linked data points one can see if there are days of either outstanding activity, or lack there of.</p>
<p>You can also see here that the week 1 observation started on a Thursday as there are only four days of observation for week 1 (and again for week 53).</p>
<pre class="r"><code># first create a new data set with an new variable that has the weekly cumulative sum of StepTotal
Daily_Steps_Week_Cumulative &lt;- Daily_Steps %&gt;% 
  group_by(weeknum) %&gt;% 
  mutate(cs = cumsum(StepTotal))

# create plot of the weekly cumulative steps
# each line is a week using group = weeknum

Weekly_Cumulative &lt;- ggplot(Daily_Steps_Week_Cumulative, aes(days, cs, group = weeknum)) +
  geom_point() +
  geom_line() +
  scale_x_continuous(breaks = seq(0,365,20), expand = c(.01, .01)) +
  scale_y_continuous(breaks = seq(0,120000,20000)) +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.line = element_line(colour = &quot;black&quot;)) +
  theme(axis.line.x = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1),
        axis.line.y = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1)) +
  theme(axis.text.x = element_text(size = 6)) +
  labs(title = &quot;Weekly Cumulative Steps&quot;, 
       x = &quot;DAYS&quot;, 
       y = &quot;STEPS&quot;) +
  geom_vline(xintercept = c(32.5, 193.5)) +
  annotate(&quot;text&quot;, x = c(15, 112.5, 277.5), y = 130000, 
           label = c(&quot;BL&quot;, &quot;Intervention 1&quot;, &quot;Intervention 2&quot;))

Weekly_Cumulative</code></pre>
<p><img src="/post/2017-09-10-examining-variability-in-phsyical-activity-with-r_files/figure-html/weekly_cumulative-1.png" width="672" /></p>
</div>
<div id="proportion-of-baseline-mean-and-proportion-of-baseline-median" class="section level3">
<h3>5. Proportion of Baseline Mean and Proportion of Baseline Median</h3>
<p>In these visualizations we want to see how daily steps compared to the the mean and median of the baseline value. First we create a small data setbased on our previously created <code>observation_data</code> (see Phase Mean/Median above) that contains our baseline mean and median value, and then create our proportion data sets. After that straightforward process it’s relatively simple to generate the plots using much of the same code we’ve used previously. We also use the “end” of the baseline phase (in number of days) to create a new “days” variable so that the Intervention 1 phase starts at “day 1”.</p>
<p><em>Note</em>. I had some trouble figuring out how to properly apply a logarithmic scale to the y-axis, but a quick trip in to Stack Overflow helped me find <code>scale_y_log10</code> and use it here.</p>
<pre class="r"><code># create a dataframe of just data from the &quot;baseline&quot; phase
baseline_values &lt;- observation_data %&gt;% 
  filter(observation == &quot;Baseline&quot;)

# create a dataframe of daily proportions for &quot;intervention 1&quot; and &quot;intervention 2&quot; phases
# use the end of baseline (in days) to create new days2 variable to start &quot;intervention 1&quot; at day 1
proportions &lt;- Daily_Steps %&gt;% 
  filter(observation != &quot;Baseline&quot;) %&gt;% 
  mutate(proportion_mean = (StepTotal / baseline_values$mean),
         proportion_median = (StepTotal / baseline_values$median),
         days2 = (days - baseline_values$end))

# create mean and medians of the proportions within each phase
# also creat start/end days for use with geom_segment to create start/stop points for horizontal lines
proportions_mean_median &lt;- proportions %&gt;% 
  group_by(observation) %&gt;% 
  summarize(mean = mean(proportion_mean),
            median = median(proportion_median),
            start = min(days2), 
            end = max(days2))

# separate &quot;intervention 1&quot;  data into a dataframe for use in geom_segment
proportion_intervention1_data&lt;- proportions_mean_median %&gt;% 
  filter(observation == &quot;Intervention 1&quot;)

# separate &quot;intervention 2&quot;  data into a dataframe for use in geom_segment
proportion_intervention2_data&lt;- proportions_mean_median %&gt;% 
  filter(observation == &quot;Intervention 2&quot;)

# create mean proportion plot
# use scale_y_log10 and annotation_logticks to try and match original paper visualization
Proportion_Mean_Plot &lt;- ggplot(proportions, aes(days2, proportion_mean, group = observation)) +
  geom_line() +
  geom_point(aes(shape = observation)) + 
  scale_shape_manual(values=c(16,0)) +
  scale_x_continuous(breaks = seq(0,335,20), expand = c(.01, .01)) +
  scale_y_log10(breaks = c(0.1, 1, 10), limits = c(0.1, 10)) +
  annotation_logticks(sides = &quot;l&quot;) +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.line = element_line(colour = &quot;black&quot;)) +
  theme(axis.line.x = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1),
        axis.line.y = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1)) +
  theme(axis.text.x = element_text(size = 6)) + 
  theme(legend.position=&quot;none&quot;) +
  labs(title = &quot;Proportion of Baseline Mean&quot;,
       subtitle = &quot;Daily steps within each intervention phase&quot;,
       x = &quot;DAYS WITHIN PHASE&quot;, 
       y = &quot;PROPORTION OF BASELINE \n(MEAN)&quot;) +
  geom_vline(xintercept = 164.5) +
  geom_hline(yintercept = 1) +
  annotate(&quot;text&quot;, x = c(82, 246), y = 10,
           label = c(&quot;Intervention 1&quot;, &quot;Intervention 2&quot;)) +
  geom_segment(aes(x = 0, y = mean, xend = end, yend = mean),
               data = proportion_intervention1_data) +
  geom_segment(aes(x = start, y = mean, xend = end, yend = mean),
               data = proportion_intervention2_data, linetype = 3) 

Proportion_Mean_Plot</code></pre>
<p><img src="/post/2017-09-10-examining-variability-in-phsyical-activity-with-r_files/figure-html/proportion_mean_plot-1.png" width="672" /></p>
<pre class="r"><code># create median proportion plot
# use scale_y_log10 and annotation_logticks to try and match original paper visualization
Proportion_Median_Plot &lt;- ggplot(proportions, aes(days2, proportion_median, group = observation)) +
  geom_point(aes(shape = observation)) + 
  scale_shape_manual(values=c(16,0)) +
  geom_line() +
  scale_x_continuous(breaks = seq(0,335,20), expand = c(.01, .01)) +
  scale_y_log10(breaks = c(0.1, 1, 10), limits = c(0.1, 10)) +
  annotation_logticks(sides = &quot;l&quot;) +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.line = element_line(colour = &quot;black&quot;)) +
  theme(axis.line.x = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1),
        axis.line.y = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1)) +
  theme(axis.text.x = element_text(size = 6)) +
  theme(legend.position=&quot;none&quot;) +
  theme(axis.line.x = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1),
        axis.line.y = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1)) +
  labs(title = &quot;Proportion of Baseline Median&quot;,
       subtitle = &quot;Daily steps within each intervention phase&quot;,
       x = &quot;DAYS WITHIN PHASE&quot;, 
       y = &quot;PROPORTION OF BASELINE \n(MEDIAN)&quot;) +
  geom_vline(xintercept = 164.5) +
  geom_hline(yintercept = 1) +
  annotate(&quot;text&quot;, x = c(82, 246), y = 10,
           label = c(&quot;Intervention 1&quot;, &quot;Intervention 2&quot;)) +
  geom_segment(aes(x = 0, y = median, xend = end, yend = median),
               data = proportion_intervention1_data, linetype = 2) +
  geom_segment(aes(x = start, y = median, xend = end, yend = median),
               data = proportion_intervention2_data, linetype = 3)

Proportion_Median_Plot</code></pre>
<p><img src="/post/2017-09-10-examining-variability-in-phsyical-activity-with-r_files/figure-html/proportion_median_plot-1.png" width="672" /></p>
</div>
<div id="day-moving-average" class="section level3">
<h3>6. 7-Day Moving Average</h3>
<p>The 7-day moving average is one of my favorite methods for visualizing trends in messy highly variable time series data. As the authors of the paper noted, the running average method reduces variability, but it makes spotting those important trends much easier.</p>
<p>To calculate the 7-day average we can use the <code>zoo</code> package and it’s <code>rollmean</code> function. Note that doing so automatically will remove the first 6 days of each phase as the seventh day in each phase is the first to have a true 7-day mean value.</p>
<pre class="r"><code># install zoo package if not already installed
# install.packages(&quot;zoo&quot;)

# load zoo package
library(zoo)

# create 7-day average data set
# we only want rolling 7-day within each observation so we use group_by first
Daily_Steps_7DMAV &lt;- Daily_Steps %&gt;% 
  group_by(observation) %&gt;% 
  mutate(sevenmav = rollmean(StepTotal, 7, fill = NA, align = &quot;right&quot;))

# plot the 7-day moving average
movingavg_plot &lt;- ggplot(Daily_Steps_7DMAV, aes(days, sevenmav)) +
  geom_line(size = .35) +
  geom_point() +
  scale_x_continuous(breaks = seq(0,365,20), expand = c(.01, .01)) +
  scale_y_continuous(breaks = seq(0,35000,5000), limits = c(0,35000)) +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.line = element_line(colour = &quot;black&quot;)) +
  theme(axis.line.x = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1),
        axis.line.y = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1)) +
  theme(axis.text.x = element_text(size = 6)) +
  labs(title = &quot;7-Day Moving Average&quot;, 
       x = &quot;DAYS&quot;, 
       y = &quot;STEPS (MOVING AVERAGE)&quot;) +
  geom_vline(xintercept = c(30.5, 195.5)) +
  annotate(&quot;text&quot;, x = c(15, 112.5, 277.5), y = 38000, label = c(&quot;BL&quot;, &quot;Intervention 1&quot;, &quot;Intervention 2&quot;))

movingavg_plot</code></pre>
<p><img src="/post/2017-09-10-examining-variability-in-phsyical-activity-with-r_files/figure-html/movingavg-1.png" width="672" /></p>
</div>
<div id="confidence-intervals" class="section level3">
<h3>7. Confidence Intervals</h3>
<p>This is where my statistical knowledge begins to falter, but by relying on the methodology in the paper I was able to recreate their process for creating confidence intervals.</p>
<p>I used the freely available SMA application from <a href="http://clinicalresearcher.org/software.htm">clinicalresearcher.org</a> (as reference in the paper) to run the bootstrapping procedure to produce the confidence intervals. It’s important to note that the authors decided to reduce the number of data points to only the last 28 days of each phase (84 total days) in their analysis as the SMA software states that their bootstrapping method is primarily for “analyzing short streams (n&lt;30 per phase) of auto-correlated time-series data.” I replicated that procedure here as well. The resulting upper and lower bounds for the 95% confidence interval were then plotted. As you can see here in the plot, there is a significant difference between the <em>Baseline</em> phase and <em>Intervention 1</em> and the <em>Baseline</em> phase and <em>Intervention 2</em>.</p>
<pre class="r"><code># create new data sets that only include the last 28 days of each phase.
Baseline_28 &lt;-  Daily_Steps %&gt;% 
  filter(observation == &quot;Baseline&quot;, 
         days &gt; 2)
Intervention1_28 &lt;- Daily_Steps %&gt;% 
  filter(observation == &quot;Intervention 1&quot;,
         days &gt; (194-28))
Intervention2_28 &lt;- Daily_Steps %&gt;% 
  filter(observation == &quot;Intervention 2&quot;,
         days &gt; (365-28))

# bind all those 28-day data sets together and export it as a CSV to use in SMA application. 
SMA_Data &lt;- bind_rows(Baseline_28, Intervention1_28, Intervention2_28)
write_csv(SMA_Data, &quot;~/Downloads/SMA_Data.csv&quot;)</code></pre>
<p>After copying the “last 28” days data into the SMA application and setting the number of iterations to 20,000, the resulting output is saved as a .txt file. You can access that <a href="https://github.com/erramirez/datascience/blob/master/sevenways/SMA_Data_Output.txt">output here</a>.</p>
<p>We can then take those 95% CI values from the oputput for each phase and add them to the observation_date data set we created for the phase means/medians plots. Then we append those values to the full Daily_Steps data set and plot it!</p>
<pre class="r"><code># add 95% CI values as lowe/upper CI variables
observation_data$lowerCI &lt;- c(7211.57, 11247.89, 12070.50)
observation_data$upperCI &lt;- c(9480.32, 14303.11, 15935.50)

# append the CI values to the full Daily_Steps data set
Daily_Steps_CI &lt;- Daily_Steps %&gt;% left_join(., observation_data)

# plot the 95% CI using combination of geom_segment (for lower/upper CI lines) and geom_ribbon (for shadding)
CI_plot &lt;- ggplot(Daily_Steps_CI, aes(days, StepTotal)) +
  geom_line(size = .35) +
  geom_point() +
  scale_x_continuous(breaks = seq(0,365,20), expand = c(.01, .01)) +
  scale_y_continuous(breaks = seq(0,35000,5000)) +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.line = element_line(colour = &quot;black&quot;)) +
  theme(axis.line.x = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1),
        axis.line.y = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1)) +
  theme(axis.text.x = element_text(size = 6)) +
  labs(title = &quot;Daily Steps&quot;,
       subtitle = &quot;With 95% confidence interval&quot;,
       x = &quot;DAYS&quot;, 
       y = &quot;STEPS&quot;) +
  geom_vline(xintercept = c(30, 195)) +
  annotate(&quot;text&quot;, x = c(15, 112.5, 277.5),
           y = 38000, 
           label = c(&quot;BL&quot;, &quot;Intervention 1&quot;, &quot;Intervention 2&quot;)) +
  geom_segment(aes(x = start, y = lowerCI, xend = end, yend = lowerCI), data = observation_data, linetype = 2) +
  geom_segment(aes(x = start, y = upperCI, xend = end, yend = upperCI), data = observation_data, linetype = 2) +
  geom_ribbon(aes(ymin = lowerCI, ymax = upperCI), alpha = .2)

CI_plot</code></pre>
<p><img src="/post/2017-09-10-examining-variability-in-phsyical-activity-with-r_files/figure-html/CI_plot-1.png" width="672" /></p>
</div>
<div id="change-point-detection" class="section level3">
<h3>8. Change-point Detection</h3>
<p>Change-point detection is a very interesting method for determining when significant changes occur in time series data. Here we use the <code>changepoint</code> package and the <code>cpt.mean</code> function to detect the significant changes in the mean. The authors use <em>binnary segmentation</em> and limit the number of detectable change points to be equal to the number of phase changes (2), and I apply the same methods here. We then plot those changes with horizontal dashed lines that represent the mean values for each detected significant state. I also include the default changepoint plot here for comparison.</p>
<p>Unsurpisingly, we don’t see any agreement with the observed changepoints as determined by the analysis and the phase changes. This is due to the arbritrary definition of our phases here, but that is not to say this changepoint method is without merit. With a “real” obsered baseline/invtervention one could use this simple analtyical technique and quick visualization to see if changes in intervention(s) actually makes a significant difference in the outcome.</p>
<p>I’ll also noted, that one of the more interesting uses of changepoint detection is to run this analysis “live” on data as it is created, thus being able to have a more automated way to understand significant changes in outcomes as you’re measuring them. Something that may be useful for just-in-time interventions or more personalized measurement studies. I found <a href="https://blog.twitter.com/engineering/en_us/a/2014/breakout-detection-in-the-wild.html">this blog post from the Twitter engineering group</a> to be very helpful when I was wrapping my head around this methodology.</p>
<pre class="r"><code>#install.packages(&quot;changepoint&quot;)
library(changepoint)

# create a changepoint opject using the cpt.mean function with the parameters used in the paper
change &lt;- cpt.mean(Daily_Steps$StepTotal, method=&quot;BinSeg&quot;, Q=2)
plot(change) # the default changepoint plot</code></pre>
<p><img src="/post/2017-09-10-examining-variability-in-phsyical-activity-with-r_files/figure-html/changepoint-1.png" width="672" /></p>
<pre class="r"><code>change</code></pre>
<pre><code>## Class &#39;cpt&#39; : Changepoint Object
##        ~~   : S4 class containing 14 slots with names
##               cpts.full pen.value.full data.set cpttype method test.stat pen.type pen.value minseglen cpts ncpts.max param.est date version 
## 
## Created on  : Fri Apr 21 18:46:22 2017 
## 
## summary(.)  :
## ----------
## Created Using changepoint version 2.2.2 
## Changepoint type      : Change in mean 
## Method of analysis    : BinSeg 
## Test Statistic  : Normal 
## Type of penalty       : MBIC with value, 17.69969 
## Minimum Segment Length : 1 
## Maximum no. of cpts   : 2 
## Changepoint Locations : 94 331 
## Range of segmentations:
##      [,1] [,2]
## [1,]   94   NA
## [2,]   94  331
## 
##  For penalty values: 509315501 202651677</code></pre>
<pre class="r"><code># add a changepoint variable based on the output of the changepoint analysis
Daily_Steps &lt;- Daily_Steps %&gt;% 
  mutate(changepoints = case_when(days &lt;= 94 ~ 1,
                                  days &lt;= 331 ~ 2,
                                  days &gt; 331 ~ 3))

# create a data set of mean values for each change point to be used with geom_segment in the plot
change_means &lt;- Daily_Steps %&gt;% 
  group_by(changepoints) %&gt;% 
  summarize(mean = mean(StepTotal),
         start = min(days),
         end = max(days))

# plot it!
changepoint_plot &lt;- ggplot(Daily_Steps, aes(days, StepTotal)) +
  geom_line(size = .35) +
  geom_point() +
  scale_x_continuous(breaks = seq(0,365,20), expand = c(.01, .01)) +
  scale_y_continuous(breaks = seq(0,35000,5000), limits = c(0,35000)) +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), axis.line = element_line(colour = &quot;black&quot;)) +
  theme(axis.line.x = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1),
        axis.line.y = element_line(colour = &quot;black&quot;, size = 0.5, linetype = 1)) +
  theme(axis.text.x = element_text(size = 6)) +
  labs(title = &quot;Daily Steps&quot;,
       subtitle = &quot;With detected change points&quot;,
       x = &quot;DAYS&quot;, 
       y = &quot;STEPS&quot;) +
  geom_vline(xintercept = c(30, 195)) +
  annotate(&quot;text&quot;, x = c(15, 112.5, 277.5),
           y = 38000, 
           label = c(&quot;BL&quot;, &quot;Intervention 1&quot;, &quot;Intervention 2&quot;)) +
  geom_segment(aes(x = start, y = mean, xend = end, yend = mean), data = change_means, linetype = 2) 

changepoint_plot</code></pre>
<p><img src="/post/2017-09-10-examining-variability-in-phsyical-activity-with-r_files/figure-html/changepoint-2.png" width="672" /></p>
</div>
</div>
<div id="wrapping-up" class="section level2">
<h2>Wrapping Up</h2>
<p>Well, that was fun! I know I learned a lot more about using ggplot, and some anaytical methods, that can be used for examining time series data. I’m lucky to have <em>a lot</em> of time series data at my disposal to play around with these visualization methods and I hope this can be useful for you as well.</p>
<p>More broadly, I hope this this just another gentle push for our research community to share more code and examples alongside their published work. Sharing is caring folks!</p>
<p>As always, comments and edits are welcome. Feel free to submit a pull request or issue on Github, or just <a href="http://www.twitter.com/eramriez">ping me on twitter</a>.</p>
</div>

</main>

  <footer>
  <script src="//yihui.name/js/math-code.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true
  }
});
</script>
<script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<script async src="//yihui.name/js/center-img.js"></script>

  
  <hr/>
  Built with Hugo, blogdown, RStudio and ❤. &copy; Ernesto Ramirez 2017 | <a href="/colophon/">Colophon</a>
  
  </footer>
  </body>
</html>
